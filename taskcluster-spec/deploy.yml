---
resources:
- name: ping-web-deployment
  apiVersion: apps/v1beta2
  kind: Deployment
  metadata:
    name: ping
  spec:
    $let:
      service: {$eval: "builtService('ping')"}
    in:
      selector:
        matchLabels:
          app: taskcluster
          tc-service: ping
          tc-proc: web
      replicas: 1
      template:
        metadata:
          labels:
            app: taskcluster
            tc-service: ping
            tc-proc: web
        spec:
          containers:
          - name: ping
            image: {$eval: "service.dockerImage"}
            imagePullPolicy: Always
            args: [web]
            resources:
              requests:
                cpu: 100m
                memory: 100Mi
            env:
            - name: DEBUG
              value: '*'
            - name: PUBLIC_URL
              value: 'https://taskcluster.example.com/ping/'
            - name: PORT
              value: '80'
            - name: NODE_ENV
              value: 'production'
            - name: FORCE_SSL    # TODO
              value: 'false'
            - name: TRUST_PROXY  # TODO
              value: 'false'
            - name: MONITORING_ENABLE
              value: 'false'
            ports:
            - containerPort: 80

- name: ping-web-service
  kind: Service
  apiVersion: v1
  metadata:
    name: ping
  spec:
    $let:
      service: {$eval: "builtService('ping')"}
    in:
      type: NodePort
      selector:
        app: taskcluster
        tc-service: ping
        tc-proc: web
      ports:
      - protocol: TCP
        port: 80
        targetPort: 80

- name: tools-web-deployment
  apiVersion: apps/v1beta2
  kind: Deployment
  metadata:
    name: tools
  spec:
    $let:
      service: {$eval: "builtService('tools')"}
    in:
      selector:
        matchLabels:
          app: taskcluster
          tc-service: tools
          tc-proc: web
      replicas: 1
      template:
        metadata:
          labels:
            app: taskcluster
            tc-service: tools
            tc-proc: web
        spec:
          containers:
          - name: tools
            image: {$eval: "service.dockerImage"}
            imagePullPolicy: Always
            resources:
              requests:
                cpu: 10m
                memory: 100Mi
            env:
              - name: APPLICATION_NAME
                value: {$eval: "cfg.clusterName"}
            ports:
            - containerPort: 80

- name: tools-web-service
  kind: Service
  apiVersion: v1
  metadata:
    name: tools
  spec:
    $let:
      service: {$eval: "builtService('tools')"}
    in:
      type: NodePort
      selector:
        app: taskcluster
        tc-service: tools
        tc-proc: web
      ports:
      - protocol: TCP
        port: 80
        targetPort: 80

- name: auth-web-deployment
  apiVersion: apps/v1beta2
  kind: Deployment
  metadata:
    name: auth
  spec:
    $let:
      service: {$eval: "builtService('auth')"}
    in:
      selector:
        matchLabels:
          app: taskcluster
          tc-service: auth
          tc-proc: web
      replicas: 1
      template:
        metadata:
          labels:
            app: taskcluster
            tc-service: auth
            tc-proc: web
        spec:
          containers:
          - name: auth
            image: {$eval: "service.dockerImage"}
            imagePullPolicy: Always
            args: [web]
            resources:
              requests:
                cpu: 100m
                memory: 100Mi
            env:
              $flatten:
              - name: PORT
                value: '80'
              - name: PUBLIC_URL
                value: {$eval: "cfg.rootUrl"}
              - name: PROXY_NAME
                value: /api/auth
              - name: DEBUG
                value: 'auth:*,statsum*,taskcluster-lib-monitor*,taskcluster-lib-docs,taskcluster-lib-api*,express:*'
              - $map: {$eval: "infra.auth_secret_keys"}
                each(k):
                  name: '${k}'
                  valueFrom:
                    secretKeyRef:
                      name: '${infra.auth_secret_name}'
                      key: '${k}'
            ports:
            - containerPort: 80

- name: auth-web-service
  kind: Service
  apiVersion: v1
  metadata:
    name: auth
  spec:
    $let:
      service: {$eval: "builtService('auth')"}
    in:
      type: NodePort
      selector:
        app: taskcluster
        tc-service: auth
        tc-proc: web
      ports:
      - protocol: TCP
        port: 80
        targetPort: 80

- apiVersion: extensions/v1beta1
  kind: Ingress
  metadata:
    name: taskcluster-ingress
    annotations:
      kubernetes.io/ingress.class: "nginx"
  spec:
    tls:
    - secretName: {$eval: "cfg.tlsCertSecretName"}
      hosts:
        - {$eval: "cfg.rootHost"}
    rules:
    - host: {$eval: "cfg.rootHost"}
      http:
        paths:
        - path: /api/auth/
          backend:
            serviceName: auth
            servicePort: 80
        - path: /api/ping/
          backend:
            serviceName: ping
            servicePort: 80
        - backend:
            serviceName: tools
            servicePort: 80
